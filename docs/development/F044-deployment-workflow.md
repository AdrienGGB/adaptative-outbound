# F044: Data Pipeline - Deployment Workflow

## Overview

This document outlines the deployment workflow for Feature F044 (Data Pipeline & Background Job Processing) with proper environment separation.

---

## üå≥ Branch Strategy

```
main (production)
‚îú‚îÄ‚îÄ dev (development)
‚îî‚îÄ‚îÄ feature/F044-data-pipeline (feature branch)
```

### Branch Purposes

- **`main`**: Production-ready code (auto-deploys to Vercel production)
- **`dev`**: Active development integration branch (auto-deploys to Vercel preview)
- **`feature/F044-data-pipeline`**: F044 feature development (auto-deploys to Vercel preview)

---

## üöÄ Deployment Pipeline

### 1. Local Development (Dev Environment)

**Branch:** `feature/F044-data-pipeline`
**Database:** Local Supabase or development Supabase project
**URL:** `http://localhost:3000`

**Workflow:**
```bash
# Ensure you're on the feature branch
git checkout feature/F044-data-pipeline

# Pull latest changes
git pull origin feature/F044-data-pipeline

# Install dependencies (if needed)
cd web-app && npm install

# Start local dev server
npm run dev

# Open http://localhost:3000
```

**Environment Variables (`.env.local`):**
```bash
# Development Supabase (separate project from production)
NEXT_PUBLIC_SUPABASE_URL=https://your-dev-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_dev_anon_key

# Local development settings
NODE_ENV=development
```

**Database Setup:**
- Use a separate Supabase project for development
- Run migrations against dev database
- Test with sample/seed data (not production data)

---

### 2. Preview Environment (Vercel Preview)

**Branch:** `feature/F044-data-pipeline` (or any feature branch)
**Deployment:** Automatic on every push to feature branch
**Database:** Development Supabase project (same as local dev)
**URL:** Auto-generated by Vercel (e.g., `https://adaptive-outbound-f044-abc123.vercel.app`)

**Workflow:**
```bash
# Make changes and commit
git add .
git commit -m "feat(F044): add job queue schema"
git push origin feature/F044-data-pipeline

# Vercel automatically deploys preview
# Get preview URL from Vercel dashboard or GitHub PR comment
```

**Purpose:**
- Share work-in-progress with team
- Test in cloud environment before merging
- QA and review before promoting to dev/main

**Vercel Environment Variables (Preview):**
- Uses same environment variables as development
- Set in Vercel dashboard under "Preview" environment
- Should point to development Supabase project

---

### 3. Development Environment (Vercel - Dev Branch)

**Branch:** `dev`
**Deployment:** Automatic on merge to dev branch
**Database:** Development Supabase project
**URL:** `https://dev.yourdomain.com` (or Vercel-assigned URL)

**Workflow:**
```bash
# When feature is ready for integration testing
git checkout dev
git pull origin dev

# Merge feature branch into dev
git merge feature/F044-data-pipeline --no-ff -m "Merge F044 data pipeline into dev"

# Push to trigger deployment
git push origin dev

# Vercel deploys to dev environment
```

**Purpose:**
- Integration testing with other features
- Staging environment for team testing
- Pre-production validation

**Vercel Environment Variables (Dev):**
- Set in Vercel dashboard under specific branch deployment settings
- Points to development Supabase project

---

### 4. Production Environment (Vercel - Main Branch)

**Branch:** `main`
**Deployment:** Automatic on merge to main (protected branch)
**Database:** Production Supabase project
**URL:** `https://yourdomain.com` (or Vercel production domain)

**Workflow:**
```bash
# After thorough testing in dev
git checkout main
git pull origin main

# Merge dev into main (or feature branch if dev not used)
git merge dev --no-ff -m "Release F044: Data Pipeline to production"

# Push to trigger production deployment
git push origin main

# Vercel deploys to production
```

**Purpose:**
- Live production environment
- Real user data and traffic
- Requires highest level of testing and approval

**Vercel Environment Variables (Production):**
```bash
NEXT_PUBLIC_SUPABASE_URL=https://your-prod-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_prod_anon_key
NODE_ENV=production
```

---

## üìä Environment Comparison

| Environment | Branch | Database | Vercel Deployment | URL | Purpose |
|-------------|--------|----------|-------------------|-----|---------|
| **Local** | `feature/F044-data-pipeline` | Dev Supabase | None (local) | `localhost:3000` | Active development |
| **Preview** | `feature/F044-data-pipeline` | Dev Supabase | Auto (per push) | Vercel-generated | Feature review & QA |
| **Dev** | `dev` | Dev Supabase | Auto (on merge) | `dev.yourdomain.com` | Integration testing |
| **Production** | `main` | Prod Supabase | Auto (on merge) | `yourdomain.com` | Live production |

---

## üóÑÔ∏è Database Migration Strategy

### Development Phase

**All database changes happen in development Supabase first:**

1. **Create Migration Locally:**
   ```bash
   # In supabase/ directory
   npx supabase migration new f044_job_queue_schema
   ```

2. **Edit Migration File:**
   ```sql
   -- supabase/migrations/20250118_f044_job_queue_schema.sql
   CREATE TABLE jobs (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     workspace_id UUID REFERENCES workspaces(id) ON DELETE CASCADE,
     -- ... rest of schema
   );
   ```

3. **Test Migration Locally:**
   ```bash
   # Apply to local Supabase
   npx supabase db reset

   # Or apply specific migration
   npx supabase db push
   ```

4. **Apply to Dev Supabase:**
   - Go to Supabase Dashboard (dev project)
   - SQL Editor ‚Üí Run migration SQL
   - Verify with `SELECT * FROM jobs LIMIT 1;`

5. **Commit Migration File:**
   ```bash
   git add supabase/migrations/
   git commit -m "feat(F044): add job queue database schema"
   git push origin feature/F044-data-pipeline
   ```

### Production Migration (After Testing)

**Only run migrations in production after thorough testing in dev:**

1. **Merge Feature to Main:**
   ```bash
   git checkout main
   git merge feature/F044-data-pipeline
   git push origin main
   ```

2. **Apply Migration to Production Supabase:**
   - Go to Supabase Dashboard (production project)
   - SQL Editor ‚Üí Run migration SQL
   - **IMPORTANT:** Test with `SELECT` queries first
   - Verify RLS policies are applied

3. **Backup Before Migration:**
   - Take database snapshot in Supabase dashboard
   - Export critical tables as CSV backup

---

## ‚úÖ Pre-Deployment Checklist

### Before Merging to Dev

- [ ] All unit tests passing (`npm run test`)
- [ ] Build succeeds locally (`npm run build`)
- [ ] Database migrations tested in dev Supabase
- [ ] RLS policies verified
- [ ] Environment variables documented
- [ ] Code reviewed by at least one team member
- [ ] Feature documentation updated

### Before Merging to Main (Production)

- [ ] All dev checklist items complete
- [ ] Feature tested end-to-end in dev environment
- [ ] Performance testing completed (1000 jobs/min target)
- [ ] Security review completed
- [ ] Database migration tested in dev
- [ ] Rollback plan documented
- [ ] Stakeholder approval obtained
- [ ] Production environment variables verified
- [ ] Database backup taken
- [ ] Monitor setup for new features (logs, alerts)

---

## üîÑ Rollback Procedure

### If Deployment Fails

**Vercel Deployment:**
1. Go to Vercel dashboard
2. Find previous successful deployment
3. Click "Promote to Production" or "Redeploy"

**Git Rollback:**
```bash
# Identify last good commit
git log --oneline

# Revert to previous commit
git revert <commit-hash>
git push origin main

# Or hard reset (use with caution)
git reset --hard <commit-hash>
git push origin main --force
```

**Database Rollback:**
1. Restore from Supabase backup (if migration caused issues)
2. Run reverse migration SQL (if available)
3. Manually revert schema changes via SQL Editor

---

## üìù Feature Development Workflow

### Daily Workflow for F044

```bash
# Morning: Start work
git checkout feature/F044-data-pipeline
git pull origin feature/F044-data-pipeline
npm run dev  # Start local server

# During day: Make changes
# ... code, test, commit frequently ...
git add .
git commit -m "feat(F044): implement job worker"
git push origin feature/F044-data-pipeline

# Vercel automatically creates preview deployment

# End of day: Push progress
git push origin feature/F044-data-pipeline
```

### When Feature is Complete

```bash
# 1. Final testing in preview environment
# Visit Vercel preview URL, test all functionality

# 2. Merge to dev for integration testing
git checkout dev
git pull origin dev
git merge feature/F044-data-pipeline --no-ff
git push origin dev

# 3. Test in dev environment
# Visit dev.yourdomain.com, run full test suite

# 4. After approval, merge to main
git checkout main
git pull origin main
git merge dev --no-ff -m "Release F044: Data Pipeline to production"
git push origin main

# 5. Monitor production deployment
# Check Vercel logs, Supabase logs, test critical paths
```

---

## üîç Monitoring & Debugging

### Vercel Logs

```bash
# View deployment logs
vercel logs [deployment-url]

# View function logs (for Edge Functions)
vercel logs --follow
```

### Supabase Logs

- Go to Supabase Dashboard ‚Üí Logs
- Filter by severity (error, warning, info)
- Search for specific queries or errors

### Local Debugging

```bash
# Enable verbose logging
DEBUG=* npm run dev

# Check Supabase connection
npx supabase db dump --db-url "postgresql://..."
```

---

## üõ°Ô∏è Environment Variable Management

### Local Development (`.env.local`)

```bash
# Never commit this file
NEXT_PUBLIC_SUPABASE_URL=https://dev-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=dev_anon_key
```

### Vercel (Dashboard)

**Set variables for each environment:**

1. Go to Vercel ‚Üí Your Project ‚Üí Settings ‚Üí Environment Variables
2. Add variables:
   - Environment: Preview / Development / Production
   - Name: `NEXT_PUBLIC_SUPABASE_URL`
   - Value: (respective Supabase URL)
3. Redeploy for variables to take effect

### Supabase Vault (for Secrets)

```sql
-- Store encrypted API keys
INSERT INTO vault.secrets (name, secret)
VALUES ('apollo_api_key_template', 'encrypted_value');
```

---

## üìû Support & Resources

- **Vercel Documentation:** https://vercel.com/docs
- **Supabase Documentation:** https://supabase.com/docs
- **Project GitHub:** https://github.com/AdrienGGB/adaptative-outbound
- **Team Slack/Discord:** [Add channel link]

---

## üéØ F044-Specific Deployment Notes

### New Tables to Create

1. `workspace_settings` (API keys, BYOK)
2. `jobs` (job queue)
3. `job_logs` (audit trail)
4. `rate_limits` (Apollo.io rate limiting)

### New Edge Functions (If Used)

- `job-worker` (background job processor)
- `job-scheduler` (cron-based job trigger)

### Vercel Edge Runtime Limits

- **Max Execution Time:** 30 seconds (Edge Functions)
- **Max Response Size:** 4MB
- **Concurrency:** 1000 concurrent executions (Pro plan)

**Recommendation for F044:**
- For long-running jobs (>30s), consider:
  - Supabase Edge Functions (60s timeout)
  - External worker service (e.g., Railway, Render)
  - Chunking jobs into smaller sub-jobs

---

## ‚úÖ Current Status

- [x] Feature branch `feature/F044-data-pipeline` created
- [x] Branch pushed to GitHub
- [x] Deployment workflow documented
- [ ] Database migrations ready
- [ ] Environment variables configured in Vercel
- [ ] Development Supabase project set up
- [ ] Preview deployment tested
- [ ] Feature implementation (pending)

---

**Last Updated:** January 18, 2025
**Feature Owner:** Adrien
**Deployment Engineer:** Claude Code
